<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Pyrogenesis: How to write components</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Pyrogenesis
   &#160;<span id="projectnumber">13997</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">How to write components </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>See the <a href="http://trac.wildfiregames.com/wiki/TDD_Simulation">Trac wiki</a> for more documentation about this system.</em></p>
<p><em></em></p>
<ul>
<li><a class="el" href="writing-components.html#defining-cpp-interfaces">Defining interfaces in C++</a></li>
<li><a class="el" href="writing-components.html#script-wrapper">Interface method script wrappers</a></li>
<li><a class="el" href="writing-components.html#script-conversions">Script type conversions</a></li>
<li><a class="el" href="writing-components.html#defining-cpp-components">Defining component types in C++</a><ul>
<li><a class="el" href="writing-components.html#messages">Message handling</a></li>
<li><a class="el" href="writing-components.html#component-creation">Component creation</a></li>
<li><a class="el" href="writing-components.html#schema">Component XML schemas</a></li>
</ul>
</li>
<li><a class="el" href="writing-components.html#allowing-js-interfaces">Allowing interfaces to be implemented in JS</a></li>
<li><a class="el" href="writing-components.html#defining-js-components">Defining component types in JS</a></li>
<li><a class="el" href="writing-components.html#defining-js-interfaces">Defining interface types in JS</a></li>
<li><a class="el" href="writing-components.html#defining-cpp-message">Defining a new message type in C++</a></li>
<li><a class="el" href="writing-components.html#defining-js-message">Defining a new message type in JS</a></li>
<li><a class="el" href="writing-components.html#communication">Component communication</a><ul>
<li><a class="el" href="writing-components.html#message-passing">Message passing</a></li>
<li><a class="el" href="writing-components.html#query-interface">Retrieving interfaces</a></li>
</ul>
</li>
<li><a class="el" href="writing-components.html#testing">Testing components</a><ul>
<li><a class="el" href="writing-components.html#testing-cpp">Testing C++ components</a></li>
<li><a class="el" href="writing-components.html#testing-js">Testing JS components</a></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="defining-cpp-interfaces"></a>
Defining interfaces in C++</h1>
<p>Think of a name for the component. We'll use "Example" in this example; replace it with your chosen name in all the filenames and code samples below.</p>
<p>(If you copy-and-paste from the examples below, be aware that the <a href="http://trac.wildfiregames.com/wiki/Coding_Conventions">coding conventions</a> require indentation with tabs, not spaces, so make sure you get it right.)</p>
<p>Create the file <b>simulation2/components/ICmpExample.h</b>:</p>
<div class="fragment"><div class="line"><span class="comment">/* Copyright (C) 2013 Wildfire Games.</span></div>
<div class="line"><span class="comment"> * This file is part of 0 A.D.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * 0 A.D. is free software: you can redistribute it and/or modify</span></div>
<div class="line"><span class="comment"> * it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><span class="comment"> * the Free Software Foundation, either version 2 of the License, or</span></div>
<div class="line"><span class="comment"> * (at your option) any later version.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * 0 A.D. is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><span class="comment"> * GNU General Public License for more details.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></div>
<div class="line"><span class="comment"> * along with 0 A.D.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef INCLUDED_ICMPEXAMPLE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define INCLUDED_ICMPEXAMPLE</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="Interface_8h.html">simulation2/system/Interface.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// ...any other forward declarations and includes you might need...</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * Documentation to describe what this interface and its associated component types are</span></div>
<div class="line"><span class="comment"> * for, and roughly how they should be used.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">class </span><a class="code" href="classICmpExample.html">ICmpExample</a> : <span class="keyword">public</span> <a class="code" href="classIComponent.html">IComponent</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:<span class="comment"></span></div>
<div class="line"><span class="comment">    /**</span></div>
<div class="line"><span class="comment">     * Documentation for each method.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classICmpExample.html#a75b9d2c7008bd1291207b741b7312b53">DoWhatever</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"></div>
<div class="line">    <a class="code" href="Interface_8h.html#ac3e74416c4e869ae8fc094dc7313e514">DECLARE_INTERFACE_TYPE</a>(Example)</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif // INCLUDED_ICMPEXAMPLE</span></div>
</div><!-- fragment --><p>This defines the interface that C++ code will use to access components.</p>
<p>Create the file <b>simulation2/components/ICmpExample.cpp</b>:</p>
<div class="fragment"><div class="line"><span class="comment">/* Copyright (C) 2013 Wildfire Games.</span></div>
<div class="line"><span class="comment"> * ...the usual copyright header...</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;precompiled.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ICmpExample_8h.html">ICmpExample.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="InterfaceScripted_8h.html">simulation2/system/InterfaceScripted.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="InterfaceScripted_8h.html#afce423fa29276aed35d17c03dc0f203b">BEGIN_INTERFACE_WRAPPER</a>(Example)</div>
<div class="line"><a class="code" href="InterfaceScripted_8h.html#a32bd19f7361c9361861187549b0a5b5f">DEFINE_INTERFACE_METHOD_2</a>(&quot;DoWhatever&quot;, <span class="keywordtype">int</span>, <a class="code" href="classICmpExample.html">ICmpExample</a>, DoWhatever, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>)</div>
<div class="line"><span class="comment">// DEFINE_INTERFACE_METHOD for all the other methods too</span></div>
<div class="line"><a class="code" href="InterfaceScripted_8h.html#adca624674c8e92ea1e353bd6cfe8915a">END_INTERFACE_WRAPPER</a>(Example)</div>
</div><!-- fragment --><p>This defines a JavaScript wrapper, so that scripts can access methods of components implementing that interface. See <a class="el" href="writing-components.html#script-wrapper">Interface method script wrappers</a> for details.</p>
<p>This wrapper should only contain methods that are safe to access from simulation scripts: they must not crash (even with invalid or malicious inputs), they must return deterministic results, etc. Methods that are intended for use solely by C++ should not be listed here.</p>
<p>Every interface must define a script wrapper with <code>BEGIN_INTERFACE_WRAPPER</code>, though in some cases they might be empty and not define any methods.</p>
<p>Now update the file <a class="el" href="TypeList_8h.html">simulation2/TypeList.h</a> and add</p>
<div class="fragment"><div class="line"><a class="code" href="MessageTypeConversions_8cpp.html#abc8003792b58118a7e75cf2571070166">INTERFACE</a>(Example)</div>
</div><!-- fragment --><p><a class="el" href="TypeList_8h.html">TypeList.h</a> is used for various purposes - it will define the interface ID number <code>IID_Example</code> (in both C++ and JS), and it will hook the new interface into the interface registration system.</p>
<p>Remember to run the <code>update-workspaces</code> script after adding or removing any source files, so that they will be added to the makefiles or VS projects.</p>
<h1><a class="anchor" id="script-wrapper"></a>
Interface method script wrappers</h1>
<p>Interface methods are defined with the macro:</p>
<p><code>DEFINE_INTERFACE_METHOD_<em>NumberOfArguments</em>(<em>"MethodName"</em>, <em>ReturnType</em>, <a class="el" href="classICmpExample.html" title="Documentation to describe what this interface and its associated component types are for...">ICmpExample</a>, <em>MethodName</em>, <em>ArgType0</em>, <em>ArgType1</em>, ...)</code></p>
<p>corresponding to the C++ method <code><em>ReturnType</em> <a class="el" href="classICmpExample.html" title="Documentation to describe what this interface and its associated component types are for...">ICmpExample</a>::<em>MethodName</em>(<em>ArgType0</em>, <em>ArgType1</em>, ...)</code></p>
<p>For methods exposed to scripts like this, the arguments should be simple types and pass-by-value. E.g. use <code>std::wstring</code> arguments, not <code>const std::wstring&amp;</code>.</p>
<p>The arguments and return types will be automatically converted between C++ and JS values. To do this, <code>ToJSVal&lt;ReturnType&gt;</code> and <code>FromJSVal&lt;ArgTypeN&gt;</code> must be defined (if they haven't already been defined for another method), as described below.</p>
<p>The two <em>MethodName</em>s don't have to be the same - in rare cases you might want to expose it as <code>DoWhatever</code> to scripts but link it to the <code>ICmpExample::DoWhatever_wrapper()</code> method which does some extra conversions or checks or whatever.</p>
<p>There's a small limit to the number of arguments that are currently supported - if you need more, first try to save yourself some pain by using fewer arguments, otherwise you'll need to add a new macro into <a class="el" href="InterfaceScripted_8h.html">simulation2/system/InterfaceScripted.h</a> and increase <a class="el" href="ScriptInterface_8h.html#a1ad4bfc1abb82affd2a571c93eb9cc59">SCRIPT_INTERFACE_MAX_ARGS</a> in <a class="el" href="ScriptInterface_8h.html">scriptinterface/ScriptInterface.h</a>. (Not sure if anything else needs changing.)</p>
<h1><a class="anchor" id="script-conversions"></a>
Script type conversions</h1>
<p>In most cases you can skip this section. But if you define a script-accessible method with new types without having defined conversions, you'll probably get mysterious linker errors that mention <code>ToJSVal</code> or <code>FromJSVal</code>. First, work out where the conversion should be defined. Basic data types (integers, STL containers, etc) go in <a class="el" href="ScriptConversions_8cpp.html">scriptinterface/ScriptConversions.cpp</a>. Non-basic data types from the game engine typically go in <a class="el" href="EngineScriptConversions_8cpp.html">simulation2/scripting/EngineScriptConversions.cpp</a>. (They could go in different files if that turns out to be cleaner - it doesn't matter where they're defined as long as the linker finds them).</p>
<p>To convert from a C++ type <code>T</code> to a JS value, define:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;&gt; jsval ScriptInterface::ToJSVal&lt;T&gt;(JSContext* cx, <a class="code" href="secure__crt_8cpp.html#adfa3c5f81bdc5013584a4fb1c3e3be8b">T</a> <span class="keyword">const</span>&amp; val)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>Use the standard <a href="https://developer.mozilla.org/en/JSAPI_Reference">SpiderMonkey JSAPI functions</a> to do the conversion (possibly calling <code>ToJSVal</code> recursively). On error, you should return <code>JSVAL_VOID</code> (JS's <code>undefined</code> value) and probably report an error message somehow. Be careful about JS garbage collection (don't let it collect the objects you're constructing before you return them).</p>
<p>To convert from a JS value to a C++ type <code>T</code>, define:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;&gt; <span class="keywordtype">bool</span> ScriptInterface::FromJSVal&lt;T&gt;(JSContext* cx, jsval v, <a class="code" href="secure__crt_8cpp.html#adfa3c5f81bdc5013584a4fb1c3e3be8b">T</a>&amp; <a class="code" href="wdbg__sym_8cpp.html#ace3d1803d3e67865bf600d34b50328c5">out</a>)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>On error, return <code>false</code> (doesn't matter what you do with <code>out</code>). On success, return <code>true</code> and put the value in <code>out</code>. Still need to be careful about garbage collection (<code>v</code> is rooted, but it might have getters that execute arbitrary code and return unrooted values when you access properties, so don't let them be collected before you've finished using them).</p>
<h1><a class="anchor" id="defining-cpp-components"></a>
Defining component types in C++</h1>
<p>Now we want to implement the <code>Example</code> interface. We need a name for the component type - if there's only ever going to be one implementation of the interface, we might as well call it <code>Example</code> too. If there's going to be more than one, they should have distinct names like <code>ExampleStatic</code> and <code>ExampleMobile</code> etc.</p>
<p>Create <b>simulation2/components/CCmpExample.cpp</b>:</p>
<div class="fragment"><div class="line"><span class="comment">/* Copyright (C) 2013 Wildfire Games.</span></div>
<div class="line"><span class="comment"> * ...the usual copyright header...</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;precompiled.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="Component_8h.html">simulation2/system/Component.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ICmpExample_8h.html">ICmpExample.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// ... any other includes needed ...</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span><a class="code" href="classCCmpExample.html">CCmpExample</a> : <span class="keyword">public</span> ICmpExample</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classCCmpExample.html#a8878ee3d10b4f01393690b24ca99a72f">ClassInit</a>(<a class="code" href="classCComponentManager.html">CComponentManager</a>&amp; componentManager)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="Component_8h.html#a802718af26c925716144a7eb72441e6f">DEFAULT_COMPONENT_ALLOCATOR</a>(Example)</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ... member variables ...</span></div>
<div class="line"></div>
<div class="line">    static std::<span class="keywordtype">string</span> <a class="code" href="classCCmpExample.html#af1fa7d22476ddd5f84fa4840dbf0441e">GetSchema</a>()</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;ref name=&#39;anything&#39;/&gt;&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classCCmpExample.html#a8478db8a4b8aabf23c085923dc5932f5">Init</a>(<span class="keyword">const</span> <a class="code" href="classCParamNode.html">CParamNode</a>&amp; paramNode)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classCCmpExample.html#a6a9a52fcbe737cff14b08756a19ff135">Deinit</a>()</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classCCmpExample.html#a15f2d1d3e6fe23f0d8692639065f2487">Serialize</a>(<a class="code" href="classISerializer.html">ISerializer</a>&amp; serialize)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classCCmpExample.html#ac1149f4d6acc12bee3efde3152aa079f">Deserialize</a>(<span class="keyword">const</span> <a class="code" href="classCParamNode.html">CParamNode</a>&amp; paramNode, <a class="code" href="classIDeserializer.html">IDeserializer</a>&amp; deserialize)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classCCmpExample.html#ac40857023e387f6c7b1571114af9727c">HandleMessage</a>(<span class="keyword">const</span> <a class="code" href="classCMessage.html">CMessage</a>&amp; msg, <span class="keywordtype">bool</span> <a class="code" href="code__annotation_8h.html#a3e5bd53e9de4078ded1bf077b019a131">UNUSED</a>(global))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ... Implementation of interface functions: ...</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classCCmpExample.html#a7e56cc45e5df3ee2d0e729c8c17da559">DoWhatever</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> x+y;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><a class="code" href="Component_8h.html#abd6c342028e45948a03b331b417cb428">REGISTER_COMPONENT_TYPE</a>(Example)</div>
</div><!-- fragment --><p>The only optional methods are <code>HandleMessage</code> and <code>GetSchema</code> - all others must be defined.</p>
<p>Update the file <a class="el" href="TypeList_8h.html">simulation2/TypeList.h</a> and add:</p>
<div class="fragment"><div class="line"><a class="code" href="MessageTypeConversions_8cpp.html#a3a6e265e007ad5d9f218731088df122c">COMPONENT</a>(Example)</div>
</div><!-- fragment --><h2><a class="anchor" id="messages"></a>
Message handling</h2>
<p>First you need to register for all the message types you want to receive, in <code>ClassInit:</code> </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ClassInit(<a class="code" href="classCComponentManager.html">CComponentManager</a>&amp; componentManager)</div>
<div class="line">{</div>
<div class="line">    componentManager.<a class="code" href="classCComponentManager.html#abfcc0c9a12e231dbe538783cad1cc63d">SubscribeToMessageType</a>(CID_Example, <a class="code" href="Components_8h.html#aeed5f0d6bf70b510e5eb09522ea8fb6fac611eb2d9610199daa4b51508e30b3f0">MT_Update</a>);</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>(<code>CID_Example</code> is derived from the name of the component type, <em>not</em> the name of the interface.)</p>
<p>You can also use SubscribeGloballyToMessageType, to intercept messages sent with PostMessage that are targeted at a <em>different</em> entity. (Typically this is used by components that want to hear about all MT_Destroy messages.)</p>
<p>Then you need to respond to the messages in <code>HandleMessage:</code> </p>
<div class="fragment"><div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> HandleMessage(<span class="keyword">const</span> <a class="code" href="classCMessage.html">CMessage</a>&amp; msg, <span class="keywordtype">bool</span> <a class="code" href="code__annotation_8h.html#a3e5bd53e9de4078ded1bf077b019a131">UNUSED</a>(global))</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (msg.<a class="code" href="classCMessage.html#a1a02400beff0f7dff88156e05ce387d2">GetType</a>())</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code" href="Components_8h.html#aeed5f0d6bf70b510e5eb09522ea8fb6fac611eb2d9610199daa4b51508e30b3f0">MT_Update</a>:</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classCMessageUpdate.html">CMessageUpdate</a>&amp; msgData = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span><a class="code" href="classCMessageUpdate.html">CMessageUpdate</a>&amp;<span class="keyword">&gt;</span> (msg);</div>
<div class="line">        Update(msgData.<a class="code" href="classCMessageUpdate.html#acf80d33b42b9abdb40b0fd2083e069ee">turnLength</a>); <span class="comment">// or whatever processing you want to do</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The <a class="el" href="classCMessage.html">CMessage</a> structures are defined in <a class="el" href="MessageTypes_8h.html">simulation2/MessageTypes.h</a>. Be very careful that you're casting <code>msg</code> to the right type.</p>
<h2><a class="anchor" id="component-creation"></a>
Component creation</h2>
<p>Component type instances go through one of two lifecycles:</p>
<div class="fragment"><div class="line"><a class="code" href="classCCmpExample.html">CCmpExample</a>();</div>
<div class="line"><a class="code" href="h__mgr_8cpp.html#adc0228ec3f21047d64829d84134a46b7">Init</a>(paramNode);</div>
<div class="line"><span class="comment">// any sequence of HandleMessage and Serialize and interface methods</span></div>
<div class="line">Deinit();</div>
<div class="line">~<a class="code" href="classCCmpExample.html">CCmpExample</a>();</div>
</div><!-- fragment --><div class="fragment"><div class="line"><a class="code" href="classCCmpExample.html">CCmpExample</a>();</div>
<div class="line">Deserialize(paramNode, deserialize);</div>
<div class="line"><span class="comment">// any sequence of HandleMessage and Serialize and interface methods</span></div>
<div class="line">Deinit();</div>
<div class="line">~<a class="code" href="classCCmpExample.html">CCmpExample</a>();</div>
</div><!-- fragment --><p>The order of <code>Init</code>/<code>Deserialize</code>/<code>Deinit</code> between entities is mostly undefined, so they must not rely on other entities or components already existing; <em>except</em> that the SYSTEM_ENTITY is created before anything else and therefore may be used, and that the components for a single entity will be processed in the order determined by <a class="el" href="TypeList_8h.html">TypeList.h</a>.</p>
<p>In a typical component:</p>
<ul>
<li>The constructor should do very little, other than perhaps initialising some member variables - usually the default constructor is fine so there's no need to write one.</li>
<li><code>Init</code> should parse the <code>paramNode</code> (the data from the entity template) and store any needed data in member variables.</li>
<li><code>Deserialize</code> should often explicitly call <code>Init</code> first (to load the original template data), and then read any instance-specific data from the deserializer.</li>
<li><code>Deinit</code> should clean up any resources allocated by <code>Init</code> / <code>Deserialize</code>.</li>
<li>The destructor should clean up any resources allocated by the constructor - usually there's no need to write one.</li>
</ul>
<h2><a class="anchor" id="schema"></a>
Component XML schemas</h2>
<p>The <code>paramNode</code> passed to <code>Init</code> is constructed from XML entity template definition files. Components should define a schema, which is used for several purposes:</p>
<ul>
<li>Documentation of the XML structure expected by the component.</li>
<li>Automatic error checking that the XML matches the expectation, so the component doesn't have to do error checking itself.</li>
<li>(Hopefully at some point in the future) Automatic generation of editing tool UI.</li>
</ul>
<p><code>GetSchema</code> must return a Relax NG fragment, which will be used to construct a single global schema file. (You can run the game with the <code>-dumpSchema</code> command-line argument to see the schema). The <a href="http://relaxng.org/tutorial-20011203.html">official tutorial</a> describes most of the details of the RNG language.</p>
<p>In simple cases, you would write something like: </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> std::string GetSchema()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;&lt;element name=&#39;Name&#39;&gt;&lt;text/&gt;&lt;/element&gt;&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;&lt;element name=&#39;Height&#39;&gt;&lt;data type=&#39;nonNegativeInteger&#39;/&gt;&lt;/element&gt;&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;&lt;optional&gt;&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;&lt;element name=&#39;Eyes&#39;&gt;&lt;empty/&gt;&lt;/element&gt;&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;&lt;/optional&gt;&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> i.e. a single string (C++ automatically concatenates the quoted lines) which defines a list of elements, corresponding to an entity template XML file like: </p>
<div class="fragment"><div class="line">&lt;<a class="code" href="structEntity.html">Entity</a>&gt;</div>
<div class="line">  &lt;Example&gt;</div>
<div class="line">    &lt;Name&gt;Barney&lt;/Name&gt;</div>
<div class="line">    &lt;Height&gt;235&lt;/Height&gt;</div>
<div class="line">    &lt;Eyes/&gt;</div>
<div class="line">  &lt;/Example&gt;</div>
<div class="line">  &lt;!-- ... other components ... --&gt;</div>
<div class="line">&lt;/<a class="code" href="structEntity.html">Entity</a>&gt;</div>
</div><!-- fragment --><p>In the schema, each <code>&lt;element&gt;</code> has a name and some content. The content will typically be one of:</p>
<ul>
<li><code>&lt;empty/&gt;</code></li>
<li><code>&lt;text/&gt;</code></li>
<li><code>&lt;data type='boolean'/&gt;</code></li>
<li><code>&lt;data type='decimal'/&gt;</code></li>
<li><code>&lt;data type='nonNegativeInteger'/&gt;</code></li>
<li><code>&lt;data type='positiveInteger'/&gt;</code></li>
<li><code>&lt;ref name='nonNegativeDecimal'/&gt;</code></li>
<li><code>&lt;ref name='positiveDecimal'/&gt;</code></li>
</ul>
<p>(The last two are slightly different since they're not standard data types.)</p>
<p>Elements can be wrapped in <code>&lt;optional&gt;</code>. Groups of elements can be wrapped in <code>&lt;choice&gt;</code> to allow only one of them. The content of an <code>&lt;element&gt;</code> can be further nested elements, but note that elements may be reordered when loading an entity template: if you specify a sequence of elements it should be wrapped in <code>&lt;interleave&gt;</code>, so the schema checker will ignore reorderings of the sequence.</p>
<p>For early development of a new component, you can set the schema to <code>&lt;ref name='anything'/&gt;</code> to allow any content. If you don't define <code>GetSchema</code>, then the default is <code>&lt;empty/&gt;</code> (i.e. there must be no elements).</p>
<h1><a class="anchor" id="allowing-js-interfaces"></a>
Allowing interfaces to be implemented in JS</h1>
<p>If we want to allow both C++ and JS implementations of <code><a class="el" href="classICmpExample.html" title="Documentation to describe what this interface and its associated component types are for...">ICmpExample</a></code>, we need to define a special component type that proxies all the C++ methods to the script. Add the following to <b><a class="el" href="ICmpExample_8cpp.html">ICmpExample.cpp</a>:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ScriptComponent_8h.html">simulation2/scripting/ScriptComponent.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>CCmpExampleScripted : <span class="keyword">public</span> ICmpExample</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="Component_8h.html#a9c9b5b597b52129b5f551576b0af0f02">DEFAULT_SCRIPT_WRAPPER</a>(ExampleScripted)</div>
<div class="line"></div>
<div class="line">    virtual <span class="keywordtype">int</span> DoWhatever(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> m_Script.Call&lt;<span class="keywordtype">int</span>&gt; (<span class="stringliteral">&quot;DoWhatever&quot;</span>, x, y);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><a class="code" href="Component_8h.html#aa1bfd9c452c75582387fae2fa0a11b10">REGISTER_COMPONENT_SCRIPT_WRAPPER</a>(ExampleScripted)</div>
</div><!-- fragment --><p>Then add to <a class="el" href="TypeList_8h.html">TypeList.h</a>:</p>
<div class="fragment"><div class="line"><a class="code" href="MessageTypeConversions_8cpp.html#a3a6e265e007ad5d9f218731088df122c">COMPONENT</a>(ExampleScripted)</div>
</div><!-- fragment --><p><code>m_Script.Call</code> takes the return type as a template argument, then the name of the JS function to call and the list of parameters. You could do extra conversion work before calling the script, if necessary. You need to make sure the types are handled by <code>ToJSVal</code> and <code>FromJSVal</code> (as discussed before) as appropriate.</p>
<h1><a class="anchor" id="defining-js-components"></a>
Defining component types in JS</h1>
<p>Now we want a JS implementation of <a class="el" href="classICmpExample.html" title="Documentation to describe what this interface and its associated component types are for...">ICmpExample</a>. Think up a new name for this component, like <code>ExampleTwo</code> (but more imaginative). Then write <b>binaries/data/mods/public/simulation/components/ExampleTwo.js</b>:</p>
<div class="fragment"><div class="line"><span class="keyword">function</span> ExampleTwo() {}</div>
<div class="line"></div>
<div class="line">ExampleTwo.prototype.Schema = <span class="stringliteral">&quot;&lt;ref name=&#39;anything&#39;/&gt;&quot;</span>;</div>
<div class="line"></div>
<div class="line">ExampleTwo.prototype.Init = <span class="keyword">function</span>() {</div>
<div class="line">    ...</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">ExampleTwo.prototype.Deinit = <span class="keyword">function</span>() {</div>
<div class="line">    ...</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">ExampleTwo.prototype.OnUpdate = <span class="keyword">function</span>(msg) {</div>
<div class="line">    ...</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line">Engine.RegisterComponentType(IID_Example, <span class="stringliteral">&quot;ExampleTwo&quot;</span>, ExampleTwo);</div>
</div><!-- fragment --><p>This uses JS's <em>prototype</em> system to create what is effectively a class, called <code>ExampleTwo</code>. (If you wrote <code>new ExampleTwo()</code>, then JS would construct a new object which inherits from <code>ExampleTwo.prototype</code>, and then would call the <code>ExampleTwo</code> function with <code>this</code> set to the new object. "Inherit" here means that if you read a property (or method) of the object, which is not defined in the object, then it will be read from the prototype instead.)</p>
<p><code>Engine.RegisterComponentType</code> tells the engine to start using the JS class <code>ExampleTwo</code>, exposed (in template files etc) with the name "ExampleTwo", and implementing the interface ID <code>IID_Example</code> (i.e. the <a class="el" href="classICmpExample.html" title="Documentation to describe what this interface and its associated component types are for...">ICmpExample</a> interface).</p>
<p>The <code>Init</code> and <code>Deinit</code> functions are optional. Unlike C++, there are no <code>Serialize/Deserialize</code> functions - each JS component instance is automatically serialized and restored. (This automatic serialization restricts what you can store as properties in the object - e.g. you cannot store function closures, because they're too hard to serialize. This will serialize Strings, numbers, bools, null, undefined, arrays of serializable values whose property names are purely numeric, objects whose properties are serializable values. Cyclic structures are allowed.)</p>
<p>Instead of <code>ClassInit</code> and <code>HandleMessage</code>, you simply add functions of the form <code>On<em>MessageType</em></code>. (If you want the equivalent of SubscribeGloballyToMessageType, then use <code>OnGlobal<em>MessageType</em></code> instead.) When you call <code>RegisterComponentType</code>, it will find all such functions and automatically subscribe to the messages. The <code>msg</code> parameter is usually a straightforward mapping of the relevant <a class="el" href="classCMessage.html">CMessage</a> class onto a JS object (e.g. <code>OnUpdate</code> can read <code>msg.turnLength</code>).</p>
<h1><a class="anchor" id="defining-js-interfaces"></a>
Defining interface types in JS</h1>
<p>If an interface is only ever used by JS components, and never implemented or called directly by C++ components, then you don't need to do all of the work with defining <a class="el" href="classICmpExample.html" title="Documentation to describe what this interface and its associated component types are for...">ICmpExample</a>. Simply create a file <b>binaries/data/mods/public/simulation/components/interfaces/Example.js</b>:</p>
<div class="fragment"><div class="line">Engine.RegisterInterface(<span class="stringliteral">&quot;Example&quot;</span>);</div>
</div><!-- fragment --><p>You can then use <code>IID_Example</code> in JS components.</p>
<p>(There's no strict requirement to have a single .js file per interface definition, it's just a convention that allows mods to easily extend the game with new interfaces.)</p>
<h1><a class="anchor" id="defining-cpp-message"></a>
Defining a new message type in C++</h1>
<p>Think of a name. We'll use <code>Example</code> again. (The name should typically be a present-tense verb, possibly with a prefix to make its meaning clearer: "Update", "TurnStart", "RenderSubmit", etc).</p>
<p>Add to <a class="el" href="TypeList_8h.html">TypeList.h</a>:</p>
<div class="fragment"><div class="line"><a class="code" href="MessageTypeConversions_8cpp.html#a19809c74382adef96a276ed56316c523">MESSAGE</a>(Example)</div>
</div><!-- fragment --><p>Add to <a class="el" href="MessageTypes_8h.html">MessageTypes.h</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>CMessageExample : <span class="keyword">public</span> <a class="code" href="classCMessage.html">CMessage</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="MessageTypes_8h.html#af07739e090a10b270705d53c4ca61565">DEFAULT_MESSAGE_IMPL</a>(Example)</div>
<div class="line"></div>
<div class="line">    CMessageExample(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) :</div>
<div class="line">        x(x), y(y)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> x;</div>
<div class="line">    <span class="keywordtype">int</span> y;</div>
<div class="line">};</div>
</div><!-- fragment --><p>containing the data fields that are associated with the message. (In some cases there may be no fields.)</p>
<p>(If there are too many message types, <a class="el" href="MessageTypes_8h.html">MessageTypes.h</a> could be split into multiple files with better organisation. But for now everything is put in there.)</p>
<p>Now you have to add C++/JS conversions into <a class="el" href="MessageTypeConversions_8cpp.html">MessageTypeConversions.cpp</a>, so scripts can send and receive messages:</p>
<div class="fragment"><div class="line">jsval <a class="code" href="JSConversions_8h.html#a2c590310bc78ea5a2df66cf281db42da">CMessageExample::ToJSVal</a>(<a class="code" href="classScriptInterface.html">ScriptInterface</a>&amp; scriptInterface)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <a class="code" href="MessageTypeConversions_8cpp.html#add8e3a74df7fb9f26df3f9514658d56f">TOJSVAL_SETUP</a>();</div>
<div class="line">    <a class="code" href="MessageTypeConversions_8cpp.html#a8d2b5c652ade55cee506231bb1b13257">SET_MSG_PROPERTY</a>(x);</div>
<div class="line">    <a class="code" href="MessageTypeConversions_8cpp.html#a8d2b5c652ade55cee506231bb1b13257">SET_MSG_PROPERTY</a>(y);</div>
<div class="line">    <span class="keywordflow">return</span> OBJECT_TO_JSVAL(obj);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="classCMessage.html">CMessage</a>* CMessageExample::FromJSVal(<a class="code" href="classScriptInterface.html">ScriptInterface</a>&amp; scriptInterface, jsval val)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="MessageTypeConversions_8cpp.html#afc5756a7d29023231c3550024ba3d2d8">FROMJSVAL_SETUP</a>();</div>
<div class="line">    <a class="code" href="MessageTypeConversions_8cpp.html#acafebb3257e2e8fc0d2c01d8cc9fb9f2">GET_MSG_PROPERTY</a>(<span class="keywordtype">int</span>, x);</div>
<div class="line">    <a class="code" href="MessageTypeConversions_8cpp.html#acafebb3257e2e8fc0d2c01d8cc9fb9f2">GET_MSG_PROPERTY</a>(<span class="keywordtype">int</span>, y);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> CMessageExample(x, y);</div>
<div class="line">}</div>
</div><!-- fragment --><p>(You can use the JS API directly in here, but these macros simplify the common case of a single object with a set of scalar fields.)</p>
<p>If you don't want to support scripts sending/receiving the message, you can implement stub functions instead:</p>
<div class="fragment"><div class="line">jsval <a class="code" href="JSConversions_8h.html#a2c590310bc78ea5a2df66cf281db42da">CMessageExample::ToJSVal</a>(<a class="code" href="classScriptInterface.html">ScriptInterface</a>&amp; <a class="code" href="code__annotation_8h.html#a3e5bd53e9de4078ded1bf077b019a131">UNUSED</a>(scriptInterface))<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="keywordflow">return</span> JSVAL_VOID;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="classCMessage.html">CMessage</a>* CMessageExample::FromJSVal(<a class="code" href="classScriptInterface.html">ScriptInterface</a>&amp; <a class="code" href="code__annotation_8h.html#a3e5bd53e9de4078ded1bf077b019a131">UNUSED</a>(scriptInterface), jsval <a class="code" href="code__annotation_8h.html#a3e5bd53e9de4078ded1bf077b019a131">UNUSED</a>(val))</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="defining-js-message"></a>
Defining a new message type in JS</h1>
<p>If a message will only be sent and received by JS components, it can be defined purely in JS. For example, add to the file <b>interfaces/Example.js</b>:</p>
<div class="fragment"><div class="line"><span class="comment">// Message of the form { &quot;foo&quot;: 1, &quot;bar&quot;: &quot;baz&quot; }</span></div>
<div class="line"><span class="comment">// sent whenever the example component wants to demonstrate the message feature.</span></div>
<div class="line">Engine.RegisterMessageType(<span class="stringliteral">&quot;Example&quot;</span>);</div>
</div><!-- fragment --><p>Note that the only specification of the structure of the message is in comments - there is no need to tell the engine what properties it will have.</p>
<p>This message type can then be used from JS exactly like the <code>CMessageExample</code> defined in C++.</p>
<h1><a class="anchor" id="communication"></a>
Component communication</h1>
<h2><a class="anchor" id="message-passing"></a>
Message passing</h2>
<p>For one-to-many communication, you can send indirect messages to components.</p>
<p>From C++, use <a class="el" href="classCComponentManager.html#a5477e1ed6d204a35035386ff924af2c9" title="Send a message, targeted at a particular entity. ">CComponentManager::PostMessage</a> to send a message to a specific entity, and <a class="el" href="classCComponentManager.html#a10f64302642e6fc0aad3197b7405f150" title="Send a message, not targeted at any particular entity. ">CComponentManager::BroadcastMessage</a> to send to all entities. (In all cases, messages will only be received by components that subscribed to the corresponding message type).</p>
<div class="fragment"><div class="line">CMessageExample msg(10, 20);</div>
<div class="line">GetSimContext().GetComponentManager().PostMessage(ent, msg);</div>
<div class="line">GetSimContext().GetComponentManager().BroadcastMessage(msg);</div>
</div><!-- fragment --><p>From JS, use <a class="el" href="classCComponentManager.html#a49490ae088569f47b855e2fe54e35260">Engine.PostMessage</a> and <a class="el" href="classCComponentManager.html#a1f9f65069d0be41a0da45f37032913b3">Engine.BroadcastMessage</a>, using the <code>MT_*</code> constants to identify the message type:</p>
<div class="fragment"><div class="line">Engine.PostMessage(ent, MT_Example, { x: 10, y: 20 });</div>
<div class="line">Engine.BroadcastMessage(MT_Example, { x: 10, y: 20 });</div>
</div><!-- fragment --><p>Messages will be received and processed synchronously, before the PostMessage/BroadcastMessage calls return.</p>
<h2><a class="anchor" id="query-interface"></a>
Retrieving interfaces</h2>
<p>You can also directly retrieve the component implementing a given interface for a given entity, to call methods on it directly.</p>
<p>In C++, use <a class="el" href="classCmpPtr.html" title="A simplified syntax for accessing entity components. ">CmpPtr</a> (see its class documentation for details):</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ICmpPosition_8h.html">simulation2/components/ICmpPosition.h</a>&quot;</span></div>
<div class="line">...</div>
<div class="line">CmpPtr&lt;<a class="code" href="classICmpPosition.html">ICmpPosition</a>&gt; cmpPosition(context, ent);</div>
<div class="line"><span class="keywordflow">if</span> (!cmpPosition)</div>
<div class="line">    <span class="comment">// do something to avoid dereferencing null pointers</span></div>
<div class="line">cmpPosition-&gt;MoveTo(x, y);</div>
</div><!-- fragment --><p>In JS, use <a class="el" href="classCComponentManager.html#adb79f084f552f5c73a00d938c5c41e11">Engine.QueryInterface</a>:</p>
<div class="fragment"><div class="line">var cmpPosition = Engine.QueryInterface(ent, <a class="code" href="Components_8h.html#ac4c8ba43af69d4e97d91d0bf6b6bd13aabbbaa28e7f44ceaa1309dd54f2a49441">IID_Position</a>);</div>
<div class="line">cmpPosition.MoveTo(x, y);</div>
</div><!-- fragment --><p>(The use of <code>cmpPosition</code> in JS will throw an exception if it's null, so there's no need for explicit checks unless you expect the component may legitimately not exist and you want to handle it gracefully.)</p>
<h1><a class="anchor" id="testing"></a>
Testing components</h1>
<p>Tests are critical for ensuring and maintaining code quality, so all non-trivial components should have test cases. The first part is testing each component in isolation, to check the following aspects:</p>
<ul>
<li>Initialising the component state from template data.</li>
<li>Responding to method calls to modify and retrieve state.</li>
<li>Responding to broadcast/posted messages.</li>
<li>Serializing and deserializing, for saved games and networking.</li>
</ul>
<p>To focus on these, the communication and interaction with other components is explicitly not tested here (though it should be tested elsewhere). The code for the tested component is loaded, but all other components are replaced with <em>mock objects</em> that implement the expected interfaces but with dummy implementations (ignoring calls, returning constants, etc). The details differ depending on what language the component is written in:</p>
<h2><a class="anchor" id="testing-cpp"></a>
Testing C++ components</h2>
<p>Create the file <b>simulation2/components/tests/test_Example.h</b>, and copy it from something like test_CommandQueue.h. In particular, you need the <code>setUp</code> and <code>tearDown</code> functions to initialise <a class="el" href="classCXeromyces.html">CXeromyces</a>, and you should use <a class="el" href="classComponentTestHelper.html" title="Class to test a single component. ">ComponentTestHelper</a> to set up the test environment and construct the component for you. Then just use the component, and use <a class="el" href="namespaceCxxTest.html">CxxTest</a>'s <code>TS_*</code> macros to check things, and use <a class="el" href="classComponentTestHelper.html#ace5bdae985a86a6c65112d0a7f8b1845" title="Checks that the object roundtrips through its serialize/deserialize functions correctly. ">ComponentTestHelper::Roundtrip</a> to test serialization roundtripping.</p>
<p>Define mock component objects similarly to <a class="el" href="classMockTerrain.html" title="Simple terrain implementation with constant height of 50. ">MockTerrain</a>. Put it in <a class="el" href="ComponentTest_8h.html" title="Various common features for component test cases. ">ComponentTest.h</a> if it's usable by many component tests, or in the test_*.h file if it's specific to one test. Instantiate a mock object on the stack, and use <a class="el" href="classComponentTestHelper.html#ac5cf757a4b4ce4fe85d245faa1ba1d3e">ComponentTestHelper::AddMock</a> to make it accessible by QueryInterface.</p>
<h2><a class="anchor" id="testing-js"></a>
Testing JS components</h2>
<p>Create the file <b>binaries/data/mods/public/simulation/components/tests/test_ExampleTwo.js</b>, and write</p>
<div class="fragment"><div class="line">Engine.LoadComponentScript(<span class="stringliteral">&quot;ExampleTwo.js&quot;</span>);</div>
<div class="line">var cmp = ConstructComponent(1, <span class="stringliteral">&quot;ExampleTwo&quot;</span>);</div>
</div><!-- fragment --><p>where <code>ExampleTwo.js</code> is the component script to test, <code>1</code> is the entity ID, <code>"ExampleTwo"</code> is the component name. Then call methods on <code>cmp</code> to test it, using the <code>TS_*</code> functions defined in <b>binaries/data/tests/test_setup.js</b> for common assertions.</p>
<p>Create mock objects like</p>
<div class="fragment"><div class="line">AddMock(1, <a class="code" href="Components_8h.html#ac4c8ba43af69d4e97d91d0bf6b6bd13aabbbaa28e7f44ceaa1309dd54f2a49441">IID_Position</a>, {</div>
<div class="line">    <a class="code" href="mikktspace_8cpp.html#ad84647d52a4a4bb5097429087a4ce2e3">GetPosition</a>: <span class="keyword">function</span>() {</div>
<div class="line">        <span class="keywordflow">return</span> {x:1, y:2, z:3};</div>
<div class="line">    },</div>
<div class="line">});</div>
</div><!-- fragment --><p>giving the entity ID, interface ID, and an object that emulates as much of the interface as is needed for the test. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 14 2013 00:58:11 for Pyrogenesis by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
